<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Percentile matching" href="percentile_matching.html" /><link rel="prev" title="Results" href="../results.html" />

    <meta name="generator" content="sphinx-4.5.0, furo 2022.09.29"/>
        <title>Loss - Survey-Enhance documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=d81277517bee4d6b0349d71bb2661d4890b5617c" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Survey-Enhance documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">Survey-Enhance documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Paper</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../literature_survey/literature_survey.html">Literature survey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../results.html">Results</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Theory</span></p>
<ul class="current">
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Loss</a></li>
<li class="toctree-l1"><a class="reference internal" href="percentile_matching.html">Percentile matching</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../python_api/dataset.html">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_api/impute.html">Imputation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_api/percentile_match.html">Percentile matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_api/reweight.html">Weight calibration</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section class="tex2jax_ignore mathjax_ignore" id="loss">
<h1>Loss<a class="headerlink" href="#loss" title="Permalink to this headline">#</a></h1>
<p>The fundamental core of Survey-Enhance is the idea of measuring survey accuracy/usefulness in a singular value that packs together lots of individual targets we’re concerned about: everything from tax to benefits to demographics. We call this value the loss. The loss is a measure of how far away the survey is from the truth. It’s a single number that we can use to compare different survey designs, and to measure the impact of different survey enhancements.</p>
<p>We need to build this ourselves for any given survey, trying to be as neutral as possible. There’s strength in numbers: I’ve incorporated as many different statistics as are readily available for the UK, but of course the way I’ve constructed the loss function is the most vulnerable part of the pipeline to arbitrary assumptions. I followed the following principles:</p>
<ul class="simple">
<li><p>Put demographics into one bin, and financial statistics into another, then normalise them and weight them equally.</p></li>
<li><p>Within those bins, weight by size (e.g. “Income Tax statistics” should be weighted 200:40 to “Universal Credit statistics”, because Income Tax revenue is £200bn and Universal Credit spending is £40bn).</p></li>
</ul>
<p>So what does this look like? The following code runs the loss function on the 2019-20 FRS.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">loss.loss</span> <span class="kn">import</span> <span class="n">Loss</span><span class="p">,</span> <span class="n">calibration_parameters</span>
<span class="kn">from</span> <span class="nn">datasets.frs</span> <span class="kn">import</span> <span class="n">FRS_2019_20</span>
<span class="kn">from</span> <span class="nn">datasets.output_dataset</span> <span class="kn">import</span> <span class="n">OutputDataset</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="n">original_frs</span> <span class="o">=</span> <span class="n">OutputDataset</span><span class="o">.</span><span class="n">from_dataset</span><span class="p">(</span><span class="n">FRS_2019_20</span><span class="p">,</span> <span class="mi">2019</span><span class="p">,</span> <span class="mi">2022</span><span class="p">)()</span>

<span class="n">loss</span> <span class="o">=</span> <span class="n">Loss</span><span class="p">(</span>
    <span class="n">original_frs</span><span class="p">,</span>
    <span class="n">calibration_parameters</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;2022-01-01&quot;</span><span class="p">),</span>
    <span class="n">static_dataset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">frs_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">original_frs</span><span class="o">.</span><span class="n">household</span><span class="o">.</span><span class="n">household_weight</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">original_frs</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original FRS: </span><span class="si">{</span><span class="n">frs_loss</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Original FRS: 1.0
</pre></div>
</div>
</div>
</div>
<p>… which isn’t too exciting, because it’s normalised to 1.0 (deliberately). The value of the loss is fundamentally difficult to understand, because we don’t really think of accuracy as a single number. But we can get some level of intuition by changing the survey up a bit and seeing how the loss changes. For example: what if everyone in the FRS lied and said they had no pension income? How much less accurate would the survey be? We have some rough subjective feeling for this, so we can see what the loss function says and calibrate our mental model of accuracy to that.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FRS_2019_20_with_no_pension_income</span><span class="p">(</span><span class="n">FRS_2019_20</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;FRS_2019_20_with_no_pension_income&quot;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">FRS_2019_20</span><span class="o">.</span><span class="n">file_path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;frs_2019_20_with_no_pension_income.h5&quot;</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
        <span class="n">pension_income</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;pension_income&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;pension_income&quot;</span><span class="p">,</span> <span class="n">pension_income</span> <span class="o">*</span> <span class="mi">0</span><span class="p">)</span>


<span class="n">frs_with_no_pension_income</span> <span class="o">=</span> <span class="n">OutputDataset</span><span class="o">.</span><span class="n">from_dataset</span><span class="p">(</span>
    <span class="n">FRS_2019_20_with_no_pension_income</span><span class="p">,</span> <span class="mi">2019</span><span class="p">,</span> <span class="mi">2022</span>
<span class="p">)()</span>

<span class="n">frs_with_no_pension_income_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">frs_with_no_pension_income</span><span class="o">.</span><span class="n">household</span><span class="o">.</span><span class="n">household_weight</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
    <span class="n">frs_with_no_pension_income</span><span class="p">,</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FRS with no pension income: </span><span class="si">{</span><span class="n">frs_with_no_pension_income_loss</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>FRS with no pension income: 6.552893370459233
</pre></div>
</div>
</div>
</div>
<p>So the loss jumped to around 6. Why is that? We can check the loss function to see what’s going on:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
    <span class="n">frs_with_no_pension_income</span><span class="o">.</span><span class="n">household</span><span class="o">.</span><span class="n">household_weight</span><span class="o">.</span><span class="n">values</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">yaml</span>


<span class="nb">print</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">computation_tree</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">frs_with_no_pension_income</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loss.Programs:
  1_loss: 12.105786740918466
  2_weight: 1
  3_children:
    Loss.Programs.ChildTaxCredit:
      1_loss: 0.996940178801625
      2_weight: 13.875
      3_children:
        Loss.Programs.ChildTaxCredit.child_tax_credit_budgetary_impact:
          1_loss: 0.9938803576032499
          2_weight: 1
          3_children:
            child_tax_credit_budgetary_impact_UNITED_KINGDOM:
              1_loss: 0.03474512870643906
              2_loss_0: 0.03496522301027196
              3_y_pred: 11,288,691,857.03
              4_y_0_pred: 11,280,513,256.16
              5_y_true: 13,875,000,000.00
    Loss.Programs.HousingBenefit:
      1_loss: 0.9403234612227025
      2_weight: 15.894
      3_children:
        Loss.Programs.HousingBenefit.housing_benefit_budgetary_impact:
          1_loss: 0.9288759046814592
          2_weight: 1
          3_children:
            housing_benefit_budgetary_impact_ENGLAND:
              1_loss: 0.3096141427762169
              2_loss_0: 0.3307878655022342
              3_y_pred: 6,167,514,000.37
              4_y_0_pred: 5,907,340,083.64
              5_y_true: 13,904,269,989.62
            housing_benefit_budgetary_impact_GREAT_BRITAIN:
              1_loss: 0.294927479221772
              2_loss_0: 0.31576504441671466
              3_y_pred: 7,262,404,074.10
              4_y_0_pred: 6,962,682,927.39
              5_y_true: 15,894,000,000.00
            housing_benefit_budgetary_impact_SCOTLAND:
              1_loss: 0.22872400416684383
              2_loss_0: 0.2515104132980511
              3_y_pred: 660,194,641.54
              4_y_0_pred: 630,765,776.74
              5_y_true: 1,265,358,255.45
            housing_benefit_budgetary_impact_WALES:
              1_loss: 0.16052299929477207
              2_loss_0: 0.17189633937014331
              3_y_pred: 434,695,432.20
              4_y_0_pred: 424,577,067.00
              5_y_true: 725,288,681.20
        Loss.Programs.HousingBenefit.housing_benefit_participants:
          1_loss: 0.9517710177639459
          2_weight: 1
          3_children:
            housing_benefit_participants_GREAT_BRITAIN:
              1_loss: 0.1186021863142509
              2_loss_0: 0.12466277401210472
              3_y_pred: 1,771,957.00
              4_y_0_pred: 1,748,339.00
              5_y_true: 2,708,000.00
    Loss.Programs.IncomeSupport:
      1_loss: 1.0020913645503176
      2_weight: 0.67
      3_children:
        Loss.Programs.IncomeSupport.income_support_budgetary_impact:
          1_loss: 1.0041827291006353
          2_weight: 1
          3_children:
            income_support_budgetary_impact_ENGLAND:
              1_loss: 4.249780754066259
              2_loss_0: 4.214660249904289
              3_y_pred: 1,737,846,867.38
              4_y_0_pred: 1,733,001,493.10
              5_y_true: 567,638,888.89
            income_support_budgetary_impact_GREAT_BRITAIN:
              1_loss: 4.156487687733461
              2_loss_0: 4.127052395889945
              3_y_pred: 2,035,980,607.61
              4_y_0_pred: 2,031,135,233.34
              5_y_true: 670,000,000.00
            income_support_budgetary_impact_SCOTLAND:
              1_loss: 5.232539158996147
              2_loss_0: 5.232539158996147
              3_y_pred: 199,889,142.81
              4_y_0_pred: 199,889,142.81
              5_y_true: 60,796,296.30
            income_support_budgetary_impact_WALES:
              1_loss: 1.8586418211392282
              2_loss_0: 1.8586418211392282
              3_y_pred: 98,244,597.43
              4_y_0_pred: 98,244,597.43
              5_y_true: 41,564,814.81
    Loss.Programs.IncomeTax:
      1_loss: 6.670099754003721
      2_weight: 200
      3_children:
        Loss.Programs.IncomeTax.IncomeTaxBudgetaryImpact:
          1_loss: 1.4495706264860806
          2_weight: 1.0
          3_children:
            income_tax_ENGLAND:
              1_loss: 0.010762267044668917
              2_loss_0: 0.0006271463139645406
              3_y_pred: 160,507,298,177.05
              4_y_0_pred: 176,048,741,158.45
              5_y_true: 180,994,233,766.23
            income_tax_NORTHERN_IRELAND:
              1_loss: 0.00048283865135192387
              2_loss_0: 1.9256606637561124e-05
              3_y_pred: 2,647,231,929.95
              4_y_0_pred: 2,955,055,971.07
              5_y_true: 3,031,870,129.87
            income_tax_SCOTLAND:
              1_loss: 0.0016329619691775883
              2_loss_0: 0.00012708409748636915
              3_y_pred: 11,858,015,691.37
              4_y_0_pred: 13,283,171,589.62
              5_y_true: 13,834,571,428.57
            income_tax_UNITED_KINGDOM:
              1_loss: 0.014397364986064058
              2_loss_0: 0.0010481049598803094
              3_y_pred: 180,402,249,644.15
              4_y_0_pred: 198,363,237,593.81
              5_y_true: 205,000,000,000.00
            income_tax_WALES:
              1_loss: 5.519721810327052e-05
              2_loss_0: 0.0004043363704885881
              3_y_pred: 5,389,703,845.79
              4_y_0_pred: 6,076,268,874.68
              5_y_true: 5,574,935,064.94
            income_tax_by_income_0:
              1_loss: 0.00033164917068490484
              2_loss_0: 6.748906982749366e-05
              3_y_pred: 476,669,254.75
              4_y_0_pred: 594,159,126.47
              5_y_true: 690,717,092.34
            income_tax_by_income_1:
              1_loss: 0.0010402387322878083
              2_loss_0: 3.4312950599093186e-07
              3_y_pred: 4,610,043,189.83
              4_y_0_pred: 5,718,695,568.22
              5_y_true: 5,698,919,449.90
            income_tax_by_income_2:
              1_loss: 0.0014664567584223708
              2_loss_0: 0.0002506845888299809
              3_y_pred: 18,085,831,955.67
              4_y_0_pred: 21,555,079,012.34
              5_y_true: 20,540,275,049.12
            income_tax_by_income_3:
              1_loss: 0.002030362224970141
              2_loss_0: 0.00018280208234789676
              3_y_pred: 35,370,533,665.02
              4_y_0_pred: 40,568,586,590.97
              5_y_true: 39,368,860,510.81
            income_tax_by_income_4:
              1_loss: 0.0005755933414904142
              2_loss_0: 0.0014657527281342298
              3_y_pred: 44,890,930,581.33
              4_y_0_pred: 50,943,154,447.18
              5_y_true: 47,222,495,088.41
            income_tax_by_income_5:
              1_loss: 0.004396955264977238
              2_loss_0: 0.0022794983690308445
              3_y_pred: 18,372,848,357.89
              4_y_0_pred: 19,628,073,448.97
              5_y_true: 22,856,090,373.28
            income_tax_by_income_6:
              1_loss: 0.00030844714684624973
              2_loss_0: 1.9116027211312415e-05
              3_y_pred: 10,636,904,297.55
              4_y_0_pred: 11,268,903,161.40
              5_y_true: 11,478,388,998.04
            income_tax_by_income_7:
              1_loss: 0.011441761973320568
              2_loss_0: 0.01091179040335241
              3_y_pred: 15,963,330,604.27
              4_y_0_pred: 16,134,294,355.73
              5_y_true: 23,258,840,864.44
            income_tax_by_income_8:
              1_loss: 0.02631339684132812
              2_loss_0: 0.02631339684132812
              3_y_pred: 3,243,769,566.05
              4_y_0_pred: 3,243,769,566.05
              5_y_true: 10,773,575,638.51
            income_tax_by_income_9:
              1_loss: 0.02539162600358509
              2_loss_0: 0.02539162600358509
              3_y_pred: 28,657,747,649.16
              4_y_0_pred: 28,657,747,649.16
              5_y_true: 18,868,860,510.81
        Loss.Programs.IncomeTax.IncomeTaxParticipants:
          1_loss: 11.890628881521362
          2_weight: 1.0
          3_children:
            income_tax_payers_ENGLAND_ADDITIONAL:
              1_loss: 0.0009010046825794996
              2_loss_0: 0.0007227589804237184
              3_y_pred: 299,536.00
              4_y_0_pred: 310,751.00
              5_y_true: 407,000.00
            income_tax_payers_ENGLAND_BASIC:
              1_loss: 0.028990568749145913
              2_loss_0: 0.0010632793647991784
              3_y_pred: 18,164,574.00
              4_y_0_pred: 21,750,564.00
              5_y_true: 22,600,000.00
            income_tax_payers_ENGLAND_HIGHER:
              1_loss: 0.001199046699568731
              2_loss_0: 3.8078248690651396e-05
              3_y_pred: 3,163,153.00
              4_y_0_pred: 3,583,592.00
              5_y_true: 3,520,000.00
            income_tax_payers_NORTHERN_IRELAND_ADDITIONAL:
              1_loss: 1.299108843537418e-07
              2_loss_0: 1.299108843537418e-07
              3_y_pred: 3,563.00
              4_y_0_pred: 3,563.00
              5_y_true: 4,000.00
            income_tax_payers_NORTHERN_IRELAND_BASIC:
              1_loss: 0.0008070547280856869
              2_loss_0: 1.5750414639688642e-05
              3_y_pred: 583,406.00
              4_y_0_pred: 698,337.00
              5_y_true: 717,000.00
            income_tax_payers_NORTHERN_IRELAND_HIGHER:
              1_loss: 6.36735102040816e-05
              2_loss_0: 1.845943877551021e-05
              3_y_pred: 47,510.00
              4_y_0_pred: 53,275.00
              5_y_true: 60,000.00
            income_tax_payers_SCOTLAND_ADDITIONAL:
              1_loss: 1.9921922962962976e-05
              2_loss_0: 2.5575834074074068e-05
              3_y_pred: 25,186.00
              4_y_0_pred: 25,876.00
              5_y_true: 20,000.00
            income_tax_payers_SCOTLAND_BASIC:
              1_loss: 0.0035467197530715724
              2_loss_0: 0.00012968087888400265
              3_y_pred: 1,687,274.00
              4_y_0_pred: 2,077,695.00
              5_y_true: 2,170,000.00
            income_tax_payers_SCOTLAND_HIGHER:
              1_loss: 0.00014780775715488465
              2_loss_0: 5.2835264915082324e-06
              3_y_pred: 361,576.00
              4_y_0_pred: 413,210.00
              5_y_true: 405,000.00
            income_tax_payers_WALES_ADDITIONAL:
              1_loss: 1.2307000781250008e-05
              2_loss_0: 1.2307000781250008e-05
              3_y_pred: 9,969.00
              4_y_0_pred: 9,969.00
              5_y_true: 6,000.00
            income_tax_payers_WALES_BASIC:
              1_loss: 0.0020349541451844502
              2_loss_0: 0.00012816560364064744
              3_y_pred: 980,452.00
              4_y_0_pred: 1,189,844.00
              5_y_true: 1,260,000.00
            income_tax_payers_WALES_HIGHER:
              1_loss: 3.3385976601229484e-07
              2_loss_0: 9.717286352479793e-05
              3_y_pred: 114,158.00
              4_y_0_pred: 132,756.00
              5_y_true: 113,000.00
    Loss.Programs.PensionCredit:
      1_loss: 11.28762767221413
      2_weight: 4.466
      3_children:
        Loss.Programs.PensionCredit.pension_credit_budgetary_impact:
          1_loss: 8.461916220883241
          2_weight: 1
          3_children:
            pension_credit_budgetary_impact_ENGLAND:
              1_loss: 2.9156531127713157
              2_loss_0: 0.297061259504248
              3_y_pred: 10,398,840,643.11
              4_y_0_pred: 5,934,025,769.52
              5_y_true: 3,840,707,158.35
            pension_credit_budgetary_impact_GREAT_BRITAIN:
              1_loss: 3.1144386330497538
              2_loss_0: 0.3253896354742803
              3_y_pred: 12,347,512,708.27
              4_y_0_pred: 7,013,543,150.60
              5_y_true: 4,466,000,000.00
            pension_credit_budgetary_impact_SCOTLAND:
              1_loss: 3.664814116675755
              2_loss_0: 0.35455476491156845
              3_y_pred: 1,085,720,114.89
              4_y_0_pred: 594,362,865.18
              5_y_true: 372,533,622.56
            pension_credit_budgetary_impact_WALES:
              1_loss: 5.943786266464714
              2_loss_0: 0.8702390781055094
              3_y_pred: 862,951,950.27
              4_y_0_pred: 485,154,515.90
              5_y_true: 250,997,830.80
        Loss.Programs.PensionCredit.pension_credit_participants:
          1_loss: 14.11333912354502
          2_weight: 1
          3_children:
            pension_credit_participants_GREAT_BRITAIN:
              1_loss: 4.1200198068926746
              2_loss_0: 0.30532492617862045
              3_y_pred: 4,280,173.00
              4_y_0_pred: 2,188,428.00
              5_y_true: 1,406,000.00
            pension_credit_participants_NORTHERN_IRELAND:
              1_loss: 0.24924661918146548
              2_loss_0: 0.0033301021031315694
              3_y_pred: 115,277.00
              4_y_0_pred: 68,738.00
              5_y_true: 73,560.00
    Loss.Programs.PensionIncome:
      1_loss: 164.49260630151875
      2_weight: 107.3
      3_children:
        Loss.Programs.PensionIncome.pension_income_budgetary_impact:
          1_loss: 294.1710747907839
          2_weight: 1
          3_children:
            pension_income_budgetary_impact_ENGLAND:
              1_loss: 0.9999997794199109
              2_loss_0: 0.0021542731663359346
              3_y_pred: &#39;0.00&#39;
              4_y_0_pred: 94,878,371,294.33
              5_y_true: 90,670,000,000.00
            pension_income_budgetary_impact_NORTHERN_IRELAND:
              1_loss: 0.9999910314504612
              2_loss_0: 0.004517053051631717
              3_y_pred: &#39;0.00&#39;
              4_y_0_pred: 2,379,876,798.01
              5_y_true: 2,230,000,000.00
            pension_income_budgetary_impact_SCOTLAND:
              1_loss: 0.9999978260905009
              2_loss_0: 0.0005624402949595239
              3_y_pred: &#39;0.00&#39;
              4_y_0_pred: 9,418,185,815.43
              5_y_true: 9,200,000,000.00
            pension_income_budgetary_impact_WALES:
              1_loss: 0.9999961538572485
              2_loss_0: 0.005367111070767158
              3_y_pred: &#39;0.00&#39;
              4_y_0_pred: 4,819,044,305.03
              5_y_true: 5,200,000,000.00
        Loss.Programs.PensionIncome.pension_income_participants:
          1_loss: 34.8141378122536
          2_weight: 1
          3_children:
            pension_income_participants_ENGLAND:
              1_loss: 0.9979143921831062
              2_loss_0: 0.02770807952279969
              3_y_pred: &#39;0.00&#39;
              4_y_0_pred: 7,979,112.00
              5_y_true: 9,574,528.00
            pension_income_participants_NORTHERN_IRELAND:
              1_loss: 0.9234313652775278
              2_loss_0: 0.033148268836202005
              3_y_pred: &#39;0.00&#39;
              4_y_0_pred: 199,476.00
              5_y_true: 246,104.00
            pension_income_participants_SCOTLAND:
              1_loss: 0.9802973887302842
              2_loss_0: 0.01706980670333531
              3_y_pred: &#39;0.00&#39;
              4_y_0_pred: 868,102.00
              5_y_true: 1,000,069.00
            pension_income_participants_WALES:
              1_loss: 0.9671945443686408
              2_loss_0: 0.0322309188201993
              3_y_pred: &#39;0.00&#39;
              4_y_0_pred: 486,067.00
              5_y_true: 594,613.00
    Loss.Programs.UniversalCredit:
      1_loss: 6.0452700739001335
      2_weight: 43.657
      3_children:
        Loss.Programs.UniversalCredit.universal_credit_budgetary_impact:
          1_loss: 0.5515091927126515
          2_weight: 1
          3_children:
            universal_credit_budgetary_impact_ENGLAND:
              1_loss: 0.11256544594368158
              2_loss_0: 0.18237610176924823
              3_y_pred: 25,428,239,107.43
              4_y_0_pred: 21,924,977,400.92
              5_y_true: 38,267,176,499.79
            universal_credit_budgetary_impact_GREAT_BRITAIN:
              1_loss: 0.10567797150601813
              2_loss_0: 0.17566137266458945
              3_y_pred: 29,464,914,384.31
              4_y_0_pred: 25,359,484,475.54
              5_y_true: 43,657,000,000.00
            universal_credit_budgetary_impact_SCOTLAND:
              1_loss: 0.0593429227753039
              2_loss_0: 0.12984504989139067
              3_y_pred: 2,516,853,555.62
              4_y_0_pred: 2,128,420,787.55
              5_y_true: 3,327,431,777.80
            universal_credit_budgetary_impact_WALES:
              1_loss: 0.05695533068968505
              2_loss_0: 0.11952378216913219
              3_y_pred: 1,519,821,721.26
              4_y_0_pred: 1,306,086,287.06
              5_y_true: 1,996,230,926.00
        Loss.Programs.UniversalCredit.universal_credit_participants:
          1_loss: 11.539030955087615
          2_weight: 1
          3_children:
            universal_credit_participants_GREAT_BRITAIN:
              1_loss: 0.05295461378800914
              2_loss_0: 0.005227485533058386
              3_y_pred: 5,721,123.00
              4_y_0_pred: 4,985,852.00
              5_y_true: 4,649,000.00
            universal_credit_participants_NORTHERN_IRELAND:
              1_loss: 0.04026121859481554
              2_loss_0: 0.0019374836267398506
              3_y_pred: 141,006.00
              4_y_0_pred: 121,306.00
              5_y_true: 115,770.00
    Loss.Programs.WorkingTaxCredit:
      1_loss: 0.980615006865072
      2_weight: 3.825
      3_children:
        Loss.Programs.WorkingTaxCredit.working_tax_credit_budgetary_impact:
          1_loss: 0.9803294558918838
          2_weight: 1
          3_children:
            working_tax_credit_budgetary_impact_UNITED_KINGDOM:
              1_loss: 0.11608891521407116
              2_loss_0: 0.1184383321966801
              3_y_pred: 2,521,749,346.45
              4_y_0_pred: 2,508,627,756.09
              5_y_true: 3,825,000,000.00
        Loss.Programs.WorkingTaxCredit.working_tax_credit_participants:
          1_loss: 0.9809005578382601
          2_weight: 1
          3_children:
            working_tax_credit_participants_GREAT_BRITAIN:
              1_loss: 0.04301688518753893
              2_loss_0: 0.04387395265168562
              3_y_pred: 825,395.00
              4_y_0_pred: 823,228.00
              5_y_true: 1,044,000.00
</pre></div>
</div>
</div>
</div>
<p>What this is showing us is which parts of the loss function are most sensitive to the change we made. We can see that the biggest single loss change came from the pension income category (this makes sense- zeroing out pension incomes makes it very difficult to hit total pension income statistics!). But there were lots of knock-on effects on other categories, too: total taxpayer count statistics were significantly off after the change (likely because a lot of people pay tax solely because of their pension income, since the State Pension on its own is not enough to push you into the tax system).</p>
<p>As another sanity check, let’s see what the loss is if we just toned down the pension income by 10%:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FRS_2019_20_with_too_little_pension_income</span><span class="p">(</span><span class="n">FRS_2019_20</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;FRS_2019_20_with_too_little_pension_income&quot;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">FRS_2019_20</span><span class="o">.</span><span class="n">file_path</span><span class="o">.</span><span class="n">parent</span>
        <span class="o">/</span> <span class="s2">&quot;frs_2019_20_with_too_little_pension_income.h5&quot;</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
        <span class="n">pension_income</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;pension_income&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;pension_income&quot;</span><span class="p">,</span> <span class="n">pension_income</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">)</span>


<span class="n">frs_with_too_little_pension_income</span> <span class="o">=</span> <span class="n">OutputDataset</span><span class="o">.</span><span class="n">from_dataset</span><span class="p">(</span>
    <span class="n">FRS_2019_20_with_too_little_pension_income</span><span class="p">,</span> <span class="mi">2019</span><span class="p">,</span> <span class="mi">2022</span>
<span class="p">)()</span>

<span class="n">frs_with_too_little_pension_income_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="p">(</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
        <span class="n">frs_with_too_little_pension_income</span><span class="o">.</span><span class="n">household</span><span class="o">.</span><span class="n">household_weight</span><span class="o">.</span><span class="n">values</span>
    <span class="p">),</span>
    <span class="n">frs_with_too_little_pension_income</span><span class="p">,</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;FRS with 10% less pension income: </span><span class="si">{</span><span class="n">frs_with_too_little_pension_income_loss</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>FRS with 10% less pension income: 1.0334495620378865
</pre></div>
</div>
</div>
</div>
<p>… which is a much smaller change, and the loss function is much more stable- for lots of little reasons, like the fact that we didn’t cross a lot of people over boundaries between tax bands, etc. etc.</p>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./uk_experiments"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="percentile_matching.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Percentile matching</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../results.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Results</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    </body>
</html>